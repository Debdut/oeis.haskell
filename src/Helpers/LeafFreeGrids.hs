module Helpers.LeafFreeGrids (leafFreeGridsList) where
import Data.List (subsequences, genericLength, nub)
import Data.Matrix (Matrix, getElem, identity, mapRow, matrix, multStrassenMixed, nrows)
import qualified Data.Map.Strict as Map
-- Problem 64

data VertexDegree = Isolated | Leaf | Branch deriving (Eq, Show, Ord)
data Edge = Vertical Int | Horizontal Int deriving (Show)
type Histogram = Map.Map State Integer
type State = [VertexDegree]

leafFreeGridsList :: Int -> [Integer]
leafFreeGridsList n = map rightMult $ scanl f initialSs [1..] where
  states = allStates n
  k = length states
  initialSs = initialStateVector n states
  terminalSs = terminalStateVector states
  m = coefficientMatrix states
  f accum _ = m `multStrassenMixed` accum
  rightMult v = getElem 1 1 $ terminalSs `multStrassenMixed` v

-- An order of magnitude faster than `children $ replicate n Branch`
-- Gives all children of [Branch, Branch, ..., Branch]
allStates :: Int -> [State]
allStates n = nub $ map (edgeToConnectivity n) $ subsequences $ horizontal ++ vertical where
  horizontal = map Horizontal [1..n]
  vertical = verticalEdges n

children :: State -> [State]
children state = map (edgeToConnectivity n) [a ++ b | a <- horizontal, b <- vertical] where
  n = length state
  horizontal = horizontalEdgesFromState state
  vertical = subsequences $ verticalEdges n

horizontalEdgesFromState :: State -> [[Edge]]
horizontalEdgesFromState state = foldr combine [[]] (state `zip` [1..]) where
  combine (Isolated, k) listOfEdges = listOfEdges
  combine (Leaf, k) listOfEdges = map (Horizontal k:) listOfEdges
  combine (Branch, k) listOfEdges = listOfEdges ++ map (Horizontal k:) listOfEdges

verticalEdges :: Int -> [Edge]
verticalEdges n = map Vertical [1..n-1]

edgeToConnectivity :: Int -> [Edge] -> State
edgeToConnectivity n edges = map (\i -> connectivityFromCount $ count i theTally) [1..n] where
  count a as = length $ filter (==a) as
  theTally = tally edges

tally :: [Edge] -> [Int]
tally = concatMap countUp where
  countUp (Vertical a) = [a, a + 1]
  countUp (Horizontal a) = [a]

connectivityFromCount :: Int -> VertexDegree
connectivityFromCount 0 = Isolated
connectivityFromCount 1 = Leaf
connectivityFromCount _ = Branch

coefficientMatrix :: [State] -> Matrix Integer
coefficientMatrix states = matrix n n f where
  n = length states
  c = map children states
  f (i, j) = genericLength $ filter (==(states !! (i - 1))) $ c !! (j - 1)

initialStates :: Int -> [State]
initialStates n = map (edgeToConnectivity n) vertical where
  vertical = subsequences $ verticalEdges n

initialStateVector :: Int -> [State] -> Matrix Integer
initialStateVector n states = matrix (length states) 1 f where
  initial = initialStates n
  f (i, _) = if states !! (i - 1) `elem` initial then 1 else 0

terminalStateVector :: [State] -> Matrix Integer
terminalStateVector states = matrix 1 (length states) f where
  terminalStates = filter (notElem Leaf) states
  f (_, j) = if states !! (j - 1) `elem` terminalStates then 1 else 0

power :: Int -> Matrix Integer -> Matrix Integer
power 0 m = identity $ nrows m
power n m = foldr (const (`multStrassenMixed` m)) (power 0 m) [1..n]

plus :: Matrix Integer -> Matrix Integer -> Matrix Integer
plus m m' = foldr f m [1..nrows m] where
  f i = mapRow (\j -> (+ getElem i j m')) i

-- This is slow, because it computes these on n x k grids, but it's fastest
-- to compute this on a short-but-wide grid.
a320101_list :: [Integer]
a320101_list = recurse 1 where
  a n = take n $ leafFreeGridsList n
  recurse k = a k ++ recurse (k + 1)

-- The sixth row begins...
-- 1 1
-- 2 175
-- 3 58653
-- 4 20788249
-- 5 7354266811
-- 6 2602065897364
-- 7 920648306374233
-- 8 325738762201748940
-- 9 115251108547732174409
-- 10 40777517413149422922661
-- 11 14427678372214605822898479
-- 12 5104722318055248034893222356
-- 13 1806124954561027311399236949576
-- 14 639033261407831310328026075449810
-- 15 226099256396565367968374106529476575
-- 16 79997203323121626101178493422593645997
-- 17 28304173315353177291125512525554822301982
-- 18 10014427927307316431946966050891512553485294
-- 19 3543250162930304200150057240735120870628720931
-- 20 1253653409684213404387791075007071265107281688523
-- 21 443560798516435019180708119644162943439887332325347
-- 22 156938257783781293156168533451880098003142627370803856
-- 23 55527036741268743420509212693496108425927074859845157623
-- 24 19646272698618208377504780955868317665281495998625736346901
-- 25 6951136844325901098056302146621098291849623257281494939790610
-- 26 2459413252058923279857221545051505609193466864212337992470375332
-- 27 870176156773623938984108663251097034318431133488266748622512524954
-- 28 307880972497570811138675017457254209858978282378694150471617536694414
-- 29 108932763197635767949732195793812891574168159781959072688159355484790956
-- 30 38541994984655361788400909754653492071803682089697959115813702429362057903
-- 31 13636718043240083968027253972897905200907904678626240303175212330724980767569
-- 32 4824869056852545767339336124370323140563668865832758457729917912750094622087255
-- 33 1707108803009466539922412499792131837895496277207060116439676843855617134053102391
-- 34 603999907764020377889718060417052620188225351860181297015318190396111238473411834662
-- 35 213703946658707545206241023061373049860678756449922801649317555924984582991863652911694
-- 36 75611562568897788204905239512788023955045769373179150382120264241463456650000185135571839
-- 37 26752469870108488012372631106229663040758991518557864424600760614178004733718611964041194526
-- 38 9465412693976750743682754427923761357055235449879999626277663171542361231339623003467202306504
-- 39 3349000593302336596798708061179858369084435149547928335807603442589507400356458417209671367589455
-- 40 1184925088483094000858282720374706756442968676285425725062308578873012539765380801959131817362580048
-- 41 419243719491904977340059411223089484942237375987866027279359314585952616577325825762066479208286584831
-- 42 148334521769993604729904013866690607918157443094733792643797153898218968453068740494017507404410499885194
-- 43 52482909882106312624184020307290260726695389442183188974632591711542364064801859611702002916191514066199483
-- 44 18569216368690836281697054816617080251310482322742975466397192639323839054646947373796184294804070052287232456
-- 45 6570058659510765120474577743701785938721656634349116635361640748235413329861026869996572835994781573646317285014
-- 46 2324582251203293541553233091016607776729582605954819195312003815915090084218596620686579911351846762103424780255103
-- 47 822470988868119727422423190151141974177050443702043542650988808243895787607340620176677555799332941573024049907187701
-- 48 291002190685892774047585054897340485054893448529443013319443597674295455254812059849003291069794851278285264667832511798
-- 49 102960804855291009158763410192801563201741136317855425246279387427677909727157716720186175667153025661787907892053591908993
-- 50 36429029319205153300831061215270328921606611212922708265380171200016219446949791638765942914861849634920587208300306449841428
-- 51 12889120078312132799921677599044628126182501968050222564062146285522530695751119959198062301314730156772640535364873264959825946
-- 52 4560358030335070862889616085610286096715427858780875607131357557857295648224120354514731981128983121020283973547923786443516152808
-- 53 1613520957092749515343446627470094700826696926451315429140033836865056848946742057135426816220296550884949901309762629084168160372494
-- 54 570887167555617287066301090403422753441963440896703028778384388288417037840272077132686035875690321149418121828975386760470950258556733
-- 55 201988177870900217631999077126585832412127696524546948001944815261944780231444812398541866616615839103389135302409120416779347319694208818
-- 56 71466353280101815722259300488749049970954525713204442646826047641329817192586015905091508199882787788750396660209353086879127138690464293660
-- 57 25285834572064486345333004383549674280337589020292625603814621849416148866649698861072387536688920555097215155918804023574488920124191047376316
-- 58 8946495807612876023497986378195900717840321610552172178943714829855969030502042985201994315660996060595871727034275933652963633754823485105309125
-- 59 3165400256318288536187479115242501039498935383849231125638912320343580754923743282793011608398940999321579633923360759765954729760331734506452354356
-- 60 1119964620580689811174558197147221079753006039111987880200894895762304619497128181570036460757685401571821397029437648182773357878974462219325611014421
-- 61 396259761731163374318549704808469937356844267681808594309429828442725542622964244954107809736264035630665435924550274207810476440115208298976030650604067
-- 62 140202463436589833913005856685349811914380966961145882433032095236690333581789418972265648892566051454404733344597939339164778552305366928834536647549342292
-- 63 49605669442218385143164755691292960119066967602475032419025273300034330674201992941058998189898488238558943478864025184819889941468029391971925684170664656875
-- 64 17551206879639199899471902058053296313448255646944723195619077049655363970290788969458001543015836035641716205475719766672708607906630270485551855392860914778123
-- 65 6209872105258267268885084603542503459859745756632083116138904888286877180185797966647661021153893500146222323191506735031499143754757667678228678271742398795430439
-- 66 2197143012905872252037735159143946255324135254383494467025144661002658971985219219129922270804454528797988514164955436099655604506116454414449276198024164251998147681
-- 67 777381133996852551783636543271218058228021067269634484353351069913551165835824774000865670636742416251488677509244855237621471350882368971704526173643578448101643974299
-- 68 275048744639965837847594015809524941149758386185706806802462036468736789070857310855261180484313228561034981412769237267528249096285346385991226317465898031094276949126641
-- 69 97316243756858954147411539381701877158592714624153717632931297982951874074607601061840663391113820562949432356506187534255475492663438100850371918906784744986372102407793284
-- 70 34431901557453207788524842070549219068073945538972999522808883701481366148531448706609078948207441859283871245693689733622373624979052784233476444713439955258279976976933151933
-- 71 12182507247445926801476768813843424103842529648296006803179843987174946586559955212065788998569294566331305775482981087412543186121340007754998192191683671799671086302829869192814
-- 72 4310348139977956333994748922788724695172611604488855420400391018345244509569325200087339025121901973082418896779687377148560364000441322823179836000969377140429263408369312504359257
-- 73 1525063823927258692105553147288870911707117070995475936574570858786150512048897541776117536286393386531483666802437866778621754831609782956200890600844900327951801241872643687946797273
-- 74 539589748094808703278343037407650199173716111866517167130366700990839270676315649946946036874146459055900938504841759383459898398900930871311675880120478864410619571216468826417748469451
-- 75 190914695949739148300051183908337765851068900396813788824570008474570599742439940213439797828735364086355351270635414882430396793270252159228026353722017994639716967521614983813348529733962
-- 76 67548394420527741147869683664627597200743722464045740031247981392415960158005081336413643377293778114077136052037387288488796739411800639988532963394425848749415448426452550799537555591344742
-- 77 23899603779021797840231006929833433286798163956951016989298954991206191232546191040148428003609759286979085514645491313704438408159969646228633212037972099474738890794987038141860069592359030164
-- 78 8456027203818331805547572038334611822436480785810075894374863720003017596110809779422380963747761067048518757594541220490268472858479635128903128202812192745540283196779046700851312394320742265069
-- 79 2991865335210269513509528397052998834161041864344395309495229612534614199736110844100051318843942831952116106552533141123090873555037099105847978108191249778300975413675229670317136319375891197125803
-- 80 1058565443118596432883264813878170963890378569562724473720052959905339577870872807578678097297543989477336178729700849240604031205912356163670384901157258482629481806447381730971289469365517290044475432
-- 81 374535840292463213793167739614634395223022458702275405633003231391449894594161803350712037578463411665575517098948044504878705238011458016588950444453789662966209904273410588573518016918806895497600887672
-- 82 132516224268871735200159134641328212416776687544246779285773976059959587107968612889502736743599384715365223761975886777565379458225343737882908726606555032660646865205717440935983774727219435637994840081841
-- 83 46886166303244654425889113652479049313692401206277564304457087532927377394556498586358398147623471356924873012725934675937561709922475599409021648315469369753162430998384723932507826404246084878525740078570845
-- 84 16589007140402667743680717991399494043182919137255578442744338823704727869032408310291087106018262909739528503157247450218885238753386596436908275745902465209247191253652317566337840779462500166789946727699129819
-- 85 5869431851699216826670385779734236137325232931693459044598178921397755762783605446124449126799603851782959897841799022114599425243430667520738889227880112868073371383557881951909230725874787293977121291515735128156
-- 86 2076690302811279700815227710788767056487906576009057176934728711183061509846259430180149239894917402888116843817433771727910587681059889322668719036153021604359427022527217337273950934646631658546822817680784930691269
-- 87 734763214354704972167473123218934285627988887335093964382222283829847378503418687588414889310873949938337075923621988696394602539641210958617820070018541675353042734788829351306737029679931658467667343906554884633443705
-- 88 259969905208306702994640191477058675165859761939832080751058665782735707716683961171248226293607394335790839491462119384401140813524227960166053855819857352902486355640831335553109995403185615684382925541483416632108794434
-- 89 91981131191183732887653538339596363238498244091777015021303808316659714581042922188110080080449948307209250723623269932604268996239385814532546684166538413877626928506670746515761010869489508193333049283264397407418385371202
-- 90 32544261184503511079205058099897683319785233528427260115991593549892638082809904052519930049992362115062622513972187844111573015088076274190484931547518721232157443872754015170185782770134927218020220873108677400909406539746572
-- 91 11514632646164912039120066756530686161178587298666394822442243199926253279966464295629343041638700951511412089468988796215446337964625829671648203783789947579146799690497215966178836993686467466291461754671141380165691102177011288
-- 92 4074044398318071153390650036232252194307796379819557234454524993674768507754804873881228357075646896873260413286419061266101735273947399132271485220415959066456184385695328147656169771328330412272301885392601632370287816691503140568
-- 93 1441456125393193975493989890775868164364566347842456706481299289191098228579299760827552097258270111261101605937304259944610729618448452756367477638578256352622046227588578414869533879658488057048249006201962250587807285509666941967793
-- 94 510008129094360566630421378761654353364487787905333953268418334496176747486107669713250115798228079191187737367457561772831406372871316197341272642689783052647739675210202947348843539165168956728899714286073885351822515096005643214102345
-- 95 180448289171048319556568137598126230319864895324046667698338157002814954423729029208711739697068789530500446474011440146585208316580707405283554340052840561300012059079952748056533114370292954508350592746127277833669245902032490299459944739
-- 96 63845227570350750977318143556738964549807391065181922032154277517987070456304529436734321394284193666184366239747620543572188092238232290835062842111000333231099351670469175751517796031439907426707403848430864199302809916608975255161513409037
-- 97 22589369520960112625019629525171140227425853257969615988356654618718996038845800783844447644025730719031764241260702000932576634894963585328522020285662468465598755091193761738810625895380948304090096307225697184445205553649666339381422272641664
-- 98 7992447278728970617740960619795120433634533023992341195608544933454768744373594402945576229628967398031158216292849920800543443345788495321129166106329862591727454194058427921309064482898465050551087525190103074634866786443844475368511628090488108
-- 99 2827844019461906566698688682767855433244657811153567189253650408072679778177771699964505178721174732475265546754147863694282549105868041001501506686771262043159231904400823424442328862032133410712270552993278384179181458061703906839801955754456244523
-- 100 1000532317515415350806868735453081321039974476552945527082798001378708008736176514785403449156378318453793868130395515740865054881942604472366502040903654994625018933355299797975683989288173313078914780656179726704551373049300653195982803565487791893312
-- 101 354002876927863419790260202790108310102493247198388241612867104087014374149585298023082934688249262151920549802654239186924534134377641535926323813867768662419455177143858558330777713911451222671003622437910651955239171885237181808629789191013970358519972
-- 102 125251363378647908029522428419522636649098464381326104413037667364900044868513038605493233431940228566993857771390110437112828778199372280866759864802508815655284732604476495659050929849068938513954255360750649427083707840967289768417435766139941241263945885
-- 103 44315752923688496362987358424068412949735083602217097316345884373878502491200589456446643797685669011659515555507260018925162033710699740476838734209365550852735127837470161514740365369671643063551647170951354675285605574250937399407225183016529574332453728738
-- 104 15679557525105526058353347320532291710621807563203519396469145274565967628311582874989685918417774656457031517152100973312049049285635835528939535712121328090532678255483398561530909865389670626563412662651920669301385177766588551315067837493974462493808857943665
-- 105 5547655358726348427703015150414355910723554524708099228683717215008065237953431956191671020875699436991033989940155536687500566984861975793359662099762874744521898568499509289448973473559507742053228179498006897422263846401092086349891537352400377646728375482297528
-- 106 1962841102494570475658266808739737667540803123360858182207102266239778561591090295789576410072000790918810501310384502073464989668196392225571662441392316609123056747104671433458419484236832337029336863462993631177425939306397383243735256674817353888818730282972876097
-- 107 694481712455661384877507748067620409541578153593943181281405223635128826876601114408948384144878487397203758738857650353215539122508736371980420982969850513007242790027643516117200897917211320785816736278538218765372138783140772149362942054587624376410972074853145021394
-- 108 245717724334582030639508772596844353845097598601567578156195203255139175807377802175837243978788316633957335830667392390864906591070255294073472403688698509856367590919024572720877959715082976214448446064243387173505059173861829199040046445494351103561220720249737430189318
-- 109 86938502438997454567229396202906300446180404831022913637384838834454965095820169013972662760038806630991440426298347080133311875018144268078860536866925905682146673586775899325105642098831742283024621138499987694703784004116979367474393458867473151794673651812976394069740387
-- 110 30760105836092587619640601697401940793227919997203022865816039859957746950226133453999955957346675707998786617223076526525164696665270452932863101291631734380459525177750093280711493069633085324018608149800773937116334471356017301171872128904485794546518723655205091771362607925
-- 111 10883372550746784456555416583218058622293944156500515923397938972726765485563516990126197860626243918324253017721183153155149704525011253883450255024400592494548829872610654349402380996333225661622165354481065971943177292336623452045855343402585435576130313129379336869321300521848
-- 112 3850695401033601394592378167575978059618866925395767847887837013742918843429651562715450087876641627951403448691060782047126449427374000190212618798263489690396233562628974417423318595881810778531990391088861000512346451041098800104952748346576145769657335852724898358385160436275227
-- 113 1362432003719645270138047439609874537609316266739783606691928204729848313507045232748826767094166431120207531414410348782142472545801371340201064304702430030929265078388063073152286124118961608008886103834519468351329990533840480620523239247313366950505942486814100469143113955644761566
-- 114 482048246210614779777465629557980542020363963865444334450128112461708654856572852757712496724633773517299816961524407414497222522934380750061626939354421480449008565635966526767260872998561092778671105223044583026469830801478346029004353550764892916502242808872523384705036724160963883004
-- 115 170555676202792412471413330952460738022922564724928839719252511383720294522990051407362148259328465330172943789121618318959117323069580740195748334837789879944899903110244505250424320333290863576015376337740497022283019138649611898422586543187307730685700600090710633757179413041561840125262
-- 116 60345077310544150110185923507802408411966243156386578832580755639385004108771743064039053167380101192465069141950103848653239568505750258948570387117344827742482048194074659422431496568524055567154684804646381255622016925623186445976356948134419720287298326679564308817025274675425324420713282
-- 117 21350965483469084887263169330773588633583535850726740026165035916674759004704053268794080822347187370220811666529548746788352007142261032144086427812047952962148760908164506114151883958735601780860808736673876658252072777216509673762853080029652255387431669422979739874828326905246123739886786447
-- 118 7554281929747975832328549189355158839729243783692903757915216466115045430585405711766289736516710715560174364083723302738233622856912044421999854954612686799401142868902301304054646856333495064686638754113004728962723012991925973419356797860946541468141914914546390669337052402304543004909228086248
-- 119 2672814750147990985012054579042781148774312339952835097207652018617263078886307942994983658753450704736295695126654699264077074896816089658880903780830391777196346017422464260003956027606217822648879779150111682490143748430261286775129396648181075306862242840936137750388419176433999537281178359382056
-- 120 945680708642416509429235843342571681577395836518078624514069040609431047873167049614481723016141290971464765126894525402630730541528579807581621762159766454269448933905721419005651290894739449268586620480482301683875238619281850846167212368509966025889163434891815654481020255253826958362068707749396388
-- 121 334595580426554415647605173927672456230738857226470535266116812942123056561835871069923031173128428367429059277062551110593772705678259035309895083816086357795304721645492757857255061144735480256728339572310185430700119560491832470516820470830632077810336040412094134710778158539285712695864359351687051247
-- 122 118384779786509621165173922694318271519265029255391103107772187676071753462293687427401270280758242732596670550922131042853837492217024800664183401876301131177630564731019350460392173482925385061587097240084255016857896582113597791917463169624241368518308701091619261263799605686992165967742746600068600724350
-- 123 41886255841256509128392550013319823082181015990794970959910945548378009411964501516358860007193495025918218470733753849439868316465804642468155679341792278900151576758284426766428239294495133791010015905560702613126748596566550888035915622105582887247462998285305758348642168271117443338802574533037085363817561
-- 124 14819966143985022547953625649282972812733732146667823239699883695655861064139995635838449317079260550420729504087617719639759764701661811879212466071459969414771791050027482097011670926368694078405062293172131229867765981656164915978747258278107197688742248740969082029526127406586937687752016008538946432935695057
-- 125 5243519433707249400168445042814035476061347733995612061848286440178062048422129472633501077058807394490712479853721301031496927466667258489593282683110498748774795378737708948438977315793938469882752570840879938360777371701119187666751972534386426180778700039696660069376918943505610605846559315995379621577554766192
--
-- And has conjectured 18-term linear recurrence
-- a(n) = 328 * a(n-1)
--      + 9352 * a(n-2)
--      - 73707 * a(n-3)
--      - 1316926 * a(n-4)
--      + 17899527 * a(n-5)
--      - 86159484 * a(n-6)
--      + 197347344 * a(n-7)
--      - 189660665 * a(n-8)
--      - 31064889 * a(n-9)
--      + 181086417 * a(n-10)
--      - 67203429 * a(n-11)
--      - 44867092 * a(n-12)
--      + 22863191 * a(n-13)
--      + 3088843 * a(n-14)
--      - 2085907 * a(n-15)
--      - 14621 * a(n-16)
--      + 54420 * a(n-17)
--      - 3420 * a(n-18)

-- leafFreeGridsList 7
-- 1, 625, 663203, 741026781, 825905301851, 920648306374233, 1026250072710176537, 1143965408539745873837, 1275183158785657668422377, 1421452152253828727179185813, 1584498828219942788232620498897, 1766247659249238452945480673883137, 1968843862955856404845594563868994677, 2194678722658162764972606305655019272813, 2446417812155603260081260439599442236146079, 2727032458027985710587393326126906773456582147, 3039834810794432424477765318703022391389498172647, 3388516938885218332727733497580252431620473254108237, 3777194406860326980185848630119793031963795535637265557, 4210454852237119177784716503285042498691346706158481926399
